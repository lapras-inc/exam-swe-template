# 技術試験（アプリケーションのリファクタリング）

## 問題の背景

アプリケーションの開発は、スケジュールや当時の状況等により必ずしも常に最適な構成にはできません。ある程度サービスが落ち着いた段階でコードを整理し今後の開発をやりやすいように改善できるスキルが必要です。

ここに、とにかくサービスを公開しなければいけないという強いプレッシャーで開発された雑なサービスのコードがあります。
あなたの手でできる限りきれいにリファクタリングしてください。

## 問題

本アプリケーション(Refactea)は茶葉を販売するECサイトです。サービスを至急公開する必要があり、間に合わせで実装されました。本アプリケーションについて、持続開発可能な形にリファクタリングしてください。なお、サイト上のデザインについてはリファクタリングの対象外とします。

### 環境説明

本アプリケーションにはPythonとRuby実装があります。いずれかの実装を選択してリファクタリングしてください。選択した環境のディレクトリ内で`docker-compose`にて、必要なコンテナが起動します。


```
# Python実装を起動する場合
$ cd python
$ docker-compose up
```

コンテナは3つです。


```
$ docker-compose ps
           Name                          Command               State           Ports
--------------------------------------------------------------------------------------------
xxxxxxxxxxxxx_app_1           docker/service/entrypoint. ...   Up       0.0.0.0:80->80/tcp
xxxxxxxxxxxxx_paymentmock_1   python /app/app.py               Up       0.0.0.0:8810->80/tcp
xxxxxxxxxxxxx_storage_app_1   sh                               Exit 0
```


|container| role| info|
|---------|-----|-----|
|app| メインアプリケーション| リファクタリング対象のアプリケーションが稼働します。|
|paymentmock|決済サービス| appからアクセスされる決済サービスのモックサーバです。|
|storage_app|ストレージ| app用のストレージコンテナです。停止したままで問題ありません。|

`paymentmock`はリファクタリングの対象外です。`paymentmock`はいくつかの決済方法に対応するAPIサーバとなっており、リクエストを受けると`refactor_code/docker/paymentmock/mockserver/history.csv`に処理履歴を書出します。今回は、ここに履歴が書き出されれば決済完了として扱ってください。

### アプリケーション説明

アプリケーションには `http://localhost/` でアクセスできます。 本アプリケーションには以下のページがあります。

|url|method|機能|
|----|---|---|
|`/signup`|GET,POST| signupページです。|
|`/login`|GET,POST| loginページです。|
|`/logout`|GET| logoutページです。|
|`/` or `/index`|GET| 茶葉の一覧です。ログインしている場合はここから購入できます。|
|`/tea/:id`|GET|茶葉の詳細です。説明を見ることができます。ここからも購入できます。|
|`/cart`|GET,POST|現在カートに入っている茶葉の情報を見ることができます。また茶葉の購入量を下げることができます。|
|`/change_cart`|POST | カートに入っている茶葉の量を変更します。|
|`/checkout`|GET | 購入ページです。カートに入っている茶葉について決済方法を選択し、購入します。|
|`/buy`|POST | 購入を確定し、注文状態にします。|
|`/settle`|GET|購入状態になっている注文の決済処理を行うバッチ処理用のエンドポイントです。 |


`/settle`はcron等で定期的にアクセスされる想定ですが、今回はスケジューラまでは組んでいないので適宜手動でアクセスして動作確認してください。

#### 決済について

Refacteaでは、カード決済、PoyJp(架空決済サービス)、銀行引き落としが用意されています。いずれも購入確定時にアカウント情報を入力します。`/settle`へアクセスすると、その時点で未処理のOrderについて、決済サービスを通じて処理をします。
処理完了後には処理済みのステータスに変更し、決済に使用したカード番号等の情報は破棄されます。


## 採点基準

本アプリケーションへ今後行う修正がどの程度容易になるかという点を評価します。

例えば、決済方法が追加された場合や送料が一定以上で無料になるような機能拡張をする場合の変更等をイメージすると
わかりやすいかもしれません。これらのための適切なレイヤー分けや関心事を考慮した分割等を検討してください。
今回のアプリケーションは小規模なものですが、大規模なアプリケーションを扱っているという前提でリファクタリングを行ってください。(例えば現在モデルは4つですが、これが10倍になった時に何をどこに書くべきかということです)
また、明らかにアンチパターンと思われるコード・データ構造もあればその修正も試みてください。
