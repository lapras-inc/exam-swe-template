
技術試験(DB編)
=================================


背景や内部情報
------------------

* DB設計の実践的な知識を有するか
* アプリケーション変更時のデータベース側の影響について大まかに把握できるか

問題
------------

## 概要

後述の「サービス概要」の仕様を満たすWebアプリケーションのデータベースを設計してください。

## 成果物

#### ER図(あるいはそれに相当するもの)の画像

* 概略でかまいません。
* 各エンティティごとの属性よりもエンティティ間のリレーションを重視します。
  * 特に1:N, N:N, 1:1or0 等の関係については詳細に記述をお願いします。
  * 属性は主要な項目のみ記述頂ければ構いません。
* RDBMS以外のコンポーネントを利用することでパフォーマンスが向上し得る場合は利用箇所を示してください。
* ER図の記法などの正確さは評価基準に含まれません。
* UMLツールを利用する、手書きで作成したものの写真をとる、など作成方法は自由です。

#### 作業メモ

* 設計の概要や補足説明、迷った箇所などを記述ください。

## 提出方法/形式

課題の提出はプルリクエスト形式でお願いします。

* 作業メモは `/db_design_complicated` 直下に `NOTE.md` というファイルを作成してください。
* ER図はプルリクエストの本文に貼り付けてください。


サービス概要
----------------

すかうtea(仮称)は様々な茶葉を仕入れて、ユーザが独自のブレンドで購入できるB2Cサービスを運営している。

### 固有情報

以下にすかうtea特有の詳細を示す。以下の3モデル以外にも、後述の**ユースケース**を満たすために複数のモデルを定義する必要がある点に注意せよ。

#### 茶葉

* 茶葉は全体で **1万種類** 存在する
* 茶葉は100程度の仕入先がある
    * 一つの仕入先が複数の茶葉を提供している
    * 一つの茶葉が複数の仕入先を持つことはない
    * ある茶葉について **仕入先が変更される** ことはある
* 茶葉は紅茶・ウーロン茶・緑茶等、カテゴリがある
* 茶葉は渋み、甘み、苦みについて10段階の評価を事前に付けている
* 茶葉の産地を気にする(国産派等)ユーザのため、産地情報も保持する
* 茶葉ごとに在庫量を管理している
* 茶葉には価格が設定されている。これを**問屋価格**とする
    * 問屋価格は仕入れ状況等で不定期に変更される

#### ブレンド茶葉

* 現在のすかうteaでは**2種類以上**の茶葉(素材茶葉)を指定された配合でブレンドしている
* ブレンドには独自のタイトル、説明を付与できる
* ブレンド茶葉には独自の価格(**販売価格**)を設定することができる
    * 販売価格の下限は、構成する茶葉の問屋価格とし、原価割れの販売価格は設定できない
    * 問屋価格との差は販売者の利益(**販売利益**)とする
    * **問屋価格が変更される場合は、もともとの販売利益額を保持したまま販売価格が変更される**
* 作成されているブレンドの中には茶葉の組み合わせや比率が同じものも多く含まれている
* ブレンド茶葉には公開・非公開の概念があり、非公開ブレンドは作成者のみが購入できる
* すかうteaではブレンドのみが購入・販売可能であり、ベースの茶葉をそのまま販売することはない
* 渋み等の属性は、素材茶葉の属性と比率を考慮して合算したものがブレンド茶葉の属性になる
    * 甘み10の素材茶葉Aを30%, 甘み5の素材茶葉Bを70%でブレンドした場合、ブレンド茶葉の甘みは6.5になる

#### ユーザ

* **1000万人の利用者がいる**
    * ブレンド茶葉を作成しているユーザは全体の50%
    * 残りの50%はブレンドを購入するだけのユーザであり、ブレンド茶葉作成は行っていない
* ブレンドを作成しているユーザは1ユーザあたり **平均で100ブレンドほど** 作成している

### ユースケース

以下にすかうteaサービスでのユースケースを示す。

#### ブレンド茶葉作成

* 検索画面より素材となる茶葉を探す
    * 茶葉名のあいまい検索
    * 産地検索
    * 属性検索(渋み・甘み・苦味)
    * 複数検索条件についてはOR, ANDが可能
* ECサイトにおけるカートのように、選んだ茶葉を候補として保持する
* 作成画面より、候補の茶葉から実際に使用する茶葉と比率を選択し、その他の情報を入力して作成する
* 新しいブレンド茶葉が追加された場合、**1分以内に購入対象になる必要がある**

#### ブレンド茶葉管理

* 自身が作成したブレンド茶葉の一覧を確認できる
* ブレンド茶葉の名前や構成比率等の更新ができる
* 不要になったブレンド茶葉は削除できる

#### ブレンド茶葉購入

* ブレンド茶葉を検索し、購入カートに追加する
    * 検索対象は公開されているものか、自身が作成したもの
* 検索結果には以下の情報が表示される
    * ブレンド名
    * 作成者
    * 価格
    * ブレンド茶葉詳細へのリンク
* 検索条件は以下
    * 作成者
    * 構成茶葉の比率下限、上限
    * 価格
    * 在庫の有無
* 検索順序はサービスへの貢献度が高いユーザを優先するため、直近1ヶ月の販売量が多いユーザが作成したブレンド茶葉を上位とする

#### ブレンド茶葉詳細

* 作成者や比率等の情報が確認できる
* ブレンド茶葉には作成者が任意のコメントを追加することができる
* 公開されているブレンド茶葉にはすべてのユーザが任意のコメントを追加することができる

#### 購入処理

* カートに入っているブレンド茶葉を購入する
* ブレンドごとの購入量を変更・削除できる
* ブレンド茶葉の量を増加した際に在庫量を問い合わせし、在庫を超える場合は購入不可のメッセージを出す
* ブレンドは購入確定時点で、既存の在庫から引き当てて指定比率で配合後に出荷される
   * 在庫状況次第では、購入ボタン押下後に品切れで買えなかったというケースがあることは許容する
* 購入後の配送状況の追跡は外部システムで行うため本システムでは保持しない

#### 販売利益確認

* ユーザは現時点での累計販売利益と未受け取り販売利益を確認できる
* 販売利益が1000円を超えている場合はリクエストすることで振り込まれる
* より売れるブレンド作成の基礎データにするため、販売時のブレンド茶葉について茶葉の構成比率を確認できる

#### キャンペーン

* 不定期に特定の産地や仕入れ先を対象にキャンペーンが行われる
* 条件を満たしたブレンド茶葉は問屋価格が割引かれる
    * 割引分の半分だけ販売価格が下がる
    * つまり割引価格の半分だけ販売利益が増える
* 複数のキャンペーンが同時に開催されるケースもある
* キャンペーン中は、条件を満たすブレンド茶葉の作成が大量にリクエストされる
